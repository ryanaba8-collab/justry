<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>IGN Cadastre ‚Äî Freeze & Zoom Mode</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>

<!-- Map to canvas (tiles + vectors) -->
<script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>

<div id="map"></div>
<div class="toast" id="note"></div>

<!-- Top-right buttons -->
<div class="toolbar">
  <button class="btn" id="btnFreeze" title="Freeze & Zoom">üì∑ Freeze</button>
  <button class="btn" id="btnUnfreeze" title="Back to live" hidden>‚Ü©Ô∏è Unfreeze</button>
  <button class="btn" id="btnRaster" title="Toggle cadastre raster">Raster on/off</button>
</div>

<style>
html,body{height:100%;margin:0;background:#000}
#map{position:fixed;inset:0}
.area-label{background:rgba(0,0,0,.45);color:#fff;padding:4px 8px;border-radius:8px;font:14px system-ui;white-space:nowrap}
.toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111;color:#fff;
       padding:6px 10px;border-radius:8px;font:12px system-ui;opacity:0;transition:opacity .2s;z-index:1500;max-width:92vw}
.toast.show{opacity:1}

.toolbar{position:fixed;right:10px;top:10px;display:flex;gap:10px;z-index:1600}
.btn{background:#fff;border:1px solid #ddd;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.15);
     font:13px system-ui;padding:8px 10px;cursor:pointer}
.btn[hidden]{display:none}

/* === Mode "freeze" (photo) : maintenir les vecteurs visibles === */
body.leaflet-frozen .leaflet-overlay-pane { z-index: 400 !important; }
body.leaflet-frozen .leaflet-marker-pane,
body.leaflet-frozen .leaflet-overlay-pane svg,
body.leaflet-frozen .leaflet-draw-pane { z-index: 700 !important; }

/* Effet visuel lors du mode fig√© */
.leaflet-frozen {
  filter: grayscale(0.2) brightness(0.95);
  transition: filter 0.3s ease;
  cursor: zoom-in;
}
</style>

<script>
/* ---------- Base layers (IGN, keyless) ---------- */
const URL_ORTHO =
  'https://data.geopf.fr/wmts?SERVICE=WMTS&VERSION=1.0.0&REQUEST=GetTile' +
  '&STYLE=normal&TILEMATRIXSET=PM&FORMAT=image/jpeg' +
  '&LAYER=ORTHOIMAGERY.ORTHOPHOTOS&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}';

const URL_PARCELLAIRE =
  'https://data.geopf.fr/wmts?SERVICE=WMTS&VERSION=1.0.0&REQUEST=GetTile' +
  '&STYLE=normal&TILEMATRIXSET=PM&FORMAT=image/png' +
  '&LAYER=CADASTRALPARCELS.PARCELLAIRE_EXPRESS&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}';

const ignOrthos = L.tileLayer(URL_ORTHO, {
  maxZoom:22,maxNativeZoom:21,attribution:'G√©oplateforme / ¬© IGN', crossOrigin:''
});
const cadRaster = L.tileLayer(URL_PARCELLAIRE, {
  maxZoom:22,maxNativeZoom:21,opacity:.85,zIndex:600,attribution:'G√©oplateforme / ¬© IGN', crossOrigin:''
});

/* ---------- Map ---------- */
const map = L.map('map',{
  layers:[ignOrthos,cadRaster],
  maxZoom:22, minZoom:2,
  zoomSnap:1, zoomDelta:1,
  touchZoom:'center', bounceAtZoomLimits:false
}).setView([48.7064, 2.0382], 19); // Chevreuse

/* ---------- Draw + dynamic m¬≤ label ---------- */
const drawnItems = new L.FeatureGroup().addTo(map);
map.addControl(new L.Control.Draw({
  position:'topleft',
  draw:{ polygon:{ allowIntersection:false, showArea:false,
                   shapeOptions:{ color:'#1E88E5', weight:2, fillOpacity:.25 } },
         polyline:false, rectangle:false, circle:false, marker:false, circlemarker:false },
  edit:{ featureGroup: drawnItems, edit:true, remove:true }
}));

let poly=null,label=null;
const fmt=n=>!isFinite(n)?'‚Äì':(n>=100?Math.round(n).toLocaleString():n.toLocaleString(undefined,{maximumFractionDigits:2}));
const toGJ=l=>{const r=l.getLatLngs()[0].map(p=>[p.lng,p.lat]);const f=r[0],la=r[r.length-1];if(f[0]!==la[0]||f[1]!==la[1])r.push(f);return{type:"Feature",geometry:{type:"Polygon",coordinates:[r]}}};
function toast(msg){const t=document.getElementById('note');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1200);}
function updateLabel(){
  if(!poly)return;
  const gj=toGJ(poly), a=turf.area(gj);
  const c=turf.centerOfMass(gj).geometry.coordinates, latlng=[c[1],c[0]];
  const html=`<div class="area-label" title="tap to copy">${fmt(a)} m¬≤</div>`;
  if(!label){
    label=L.marker(latlng,{icon:L.divIcon({className:'',html,iconSize:null})}).addTo(map);
    const copy=()=>navigator.clipboard && navigator.clipboard.writeText(`${Math.round(a)} m¬≤`).then(()=>toast('Copied m¬≤'));
    label.on('click',copy); label.on('tap',copy);
  } else { label.setLatLng(latlng); label.setIcon(L.divIcon({className:'',html,iconSize:null})); }
}
map.on(L.Draw.Event.CREATED,e=>{drawnItems.clearLayers(); if(label){map.removeLayer(label);label=null;} poly=e.layer; drawnItems.addLayer(poly); poly.on('edit',updateLabel); updateLabel();});
map.on('draw:edited',()=>poly&&updateLabel());
map.on('draw:deleted',()=>{poly=null; if(label){map.removeLayer(label);label=null;}});

/* ---------- Cadastre dynamique multi-communes ---------- */
map.createPane('cadVectorPane');
map.getPane('cadVectorPane').style.zIndex = 650;

function strokeW(z){return Math.max(1,0.5+(z-18)*0.5);}
let cadVecGroup=L.layerGroup().addTo(map);
let loadedCommunes=new Set();
const URL_COMMUNES='https://etalab-datasets.geo.data.gouv.fr/contours-administratifs/communes-2023.geojson';
let communesIndex=null;

async function loadCommunesIndex(){
  if(communesIndex)return communesIndex;
  const res=await fetch(URL_COMMUNES);
  const geo=await res.json();
  communesIndex=geo;
  return geo;
}
function buildVectorGroup(geojson){
  const w=strokeW(map.getZoom());
  const halo=L.geoJSON(geojson,{pane:'cadVectorPane',style:{color:'#fff',weight:w+2,opacity:0.9,fill:false}});
  const stroke=L.geoJSON(geojson,{pane:'cadVectorPane',style:{color:'#ff6a00',weight:w,opacity:1.0,fill:false}});
  const g=L.layerGroup([halo,stroke]);
  g._halo=halo;g._stroke=stroke;
  return g;
}
function restyleCad(){
  const w=strokeW(map.getZoom());
  cadVecGroup.eachLayer(layer=>{
    if(layer._halo)layer._halo.setStyle({weight:w+2});
    if(layer._stroke)layer._stroke.setStyle({weight:w});
  });
}
map.on('zoomend',restyleCad);

async function loadCadastreForCommune(dep,insee){
  if(loadedCommunes.has(insee))return;
  const base=`https://cadastre.data.gouv.fr/data/etalab-cadastre/latest/geojson/communes/${dep}/${insee}`;
  const url=`${base}/cadastre-${insee}-parcelles.json.gz`;
  try{
    const res=await fetch(url,{cache:'force-cache'});
    if(!res.ok)throw new Error('HTTP '+res.status);
    const ab=await res.arrayBuffer();
    const u8=new Uint8Array(ab);
    const isGz=u8.length>=2&&u8[0]===0x1f&&u8[1]===0x8b;
    const text=isGz?pako.ungzip(u8,{to:'string'}):new TextDecoder().decode(u8);
    const geo=JSON.parse(text);
    const group=buildVectorGroup(geo);
    group.addTo(cadVecGroup);
    loadedCommunes.add(insee);
  }catch(e){console.warn(`Cadastre non disponible pour ${insee}`,e);}
}
async function updateCadastre(){
  const bounds=map.getBounds();
  const geo=await loadCommunesIndex();
  const visibles=geo.features.filter(f=>turf.booleanIntersects(f,turf.bboxPolygon([
    bounds.getWest(),bounds.getSouth(),bounds.getEast(),bounds.getNorth()
  ])));
  for(const f of visibles){
    const insee=f.properties.code;
    const dep=insee.slice(0,2).padStart(2,'0');
    loadCadastreForCommune(dep,insee);
  }
}
map.on('moveend',updateCadastre);
updateCadastre();

/* ---------- Raster on/off ---------- */
document.getElementById('btnRaster').addEventListener('click',()=>{
  if(map.hasLayer(cadRaster))map.removeLayer(cadRaster);else map.addLayer(cadRaster);
});

/* ---------- FREEZE & ZOOM MODE ---------- */
let frozen=false;
let frozenOverlay=null;
let savedLayers=[];
let savedZoomMax=null;

async function freezeView(){
  if(frozen)return;
  document.body.classList.add('leaflet-frozen');
  try{
    const canvas=await new Promise((resolve,reject)=>{
      leafletImage(map,(err,c)=>(err?reject(err):resolve(c)));
    });
    const dataURL=canvas.toDataURL('image/png');
    const bounds=map.getBounds();
    savedLayers=[];
    map.eachLayer(l=>savedLayers.push(l));
    savedLayers.forEach(l=>{if(l!==drawnItems)map.removeLayer(l);});
    frozenOverlay=L.imageOverlay(dataURL,bounds,{zIndex:400}).addTo(map);
    savedZoomMax=map.options.maxZoom;
    map.setMaxZoom(savedZoomMax+5);
    frozen=true;
    document.getElementById('btnFreeze').hidden=true;
    document.getElementById('btnUnfreeze').hidden=false;
    toast('üì∏ Mode photo activ√© : zoomez librement');
  }catch(e){
    console.error(e);
    document.body.classList.remove('leaflet-frozen');
    toast('‚ùå Impossible de capturer cette vue');
  }
}

function unfreezeView(){
  if(!frozen)return;
  document.body.classList.remove('leaflet-frozen');
  if(frozenOverlay){map.removeLayer(frozenOverlay);frozenOverlay=null;}
  if(savedLayers){savedLayers.forEach(l=>{if(!map.hasLayer(l))map.addLayer(l);});}
  map.setMaxZoom(savedZoomMax);
  frozen=false;
  document.getElementById('btnFreeze').hidden=false;
  document.getElementById('btnUnfreeze').hidden=true;
  toast('‚Ü©Ô∏è Retour √† la carte en direct');
}

document.getElementById('btnFreeze').addEventListener('click',freezeView);
document.getElementById('btnUnfreeze').addEventListener('click',unfreezeView);

/* ---------- Pr√©chargement silencieux de la capture ---------- */
// Objectif : pr√©parer leaflet-image et le cache des tuiles d√®s l'ouverture
map.whenReady(()=>{
  setTimeout(()=>{
    leafletImage(map,()=>{
      console.log('‚úÖ Pr√©chargement termin√© (moteur de capture pr√™t)');
    });
  },1000);
});
</script>

</body>
</html>
